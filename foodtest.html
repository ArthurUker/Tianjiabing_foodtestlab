<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食品安全检验管理系统</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF UMD -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- html2canvas 用于解决中文乱码，将网页内容转为图片插入PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- JSZip 用于处理Word文档 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        .nav-btn.active { background-color: #3b82f6; color: white; }
        .hidden { display: none; }
        /* 打印/截图时的背景修正 */
        .pdf-capture-mode { background-color: #ffffff !important; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部导航栏 -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-shield-alt text-2xl"></i>
                    <h1 class="text-xl font-bold">校园食品安全检验管理系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm"><i class="far fa-calendar"></i> <span id="currentDate"></span></span>
                    <span class="text-sm"><i class="far fa-user"></i> 检测员</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="container mx-auto px-4 py-6">
        <div class="flex gap-6">
            <!-- 左侧导航栏 -->
            <div class="bg-gray-800 text-white w-64 flex-shrink-0 hidden md:block rounded-lg shadow-lg h-screen sticky top-4">
                <div class="p-4 border-b border-gray-700">
                    <h1 class="text-xl font-bold">食品安全检测系统</h1>
                    <p class="text-xs text-gray-400 mt-1">Food Safety Testing System</p>
                </div>
                <nav class="p-2">
                    <ul>
                        <li class="mb-1">
                            <button class="nav-btn active w-full text-left px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" onclick="showSection('dashboard', this)">
                                <i class="fas fa-tachometer-alt mr-3"></i>数据看板
                            </button>
                        </li>
                        <li class="mb-1">
                            <button class="nav-btn w-full text-left px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" onclick="showSection('export-data', this)">
                                <i class="fas fa-file-export mr-3"></i>数据导出
                            </button>
                        </li>
                        <li class="mb-1">
                            <button class="nav-btn w-full text-left px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" onclick="showSection('tableware-test', this)">
                                <i class="fas fa-utensils mr-3"></i>餐具洁净度检测
                            </button>
                        </li>
                        <li class="mb-1">
                            <button class="nav-btn w-full text-left px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" onclick="showSection('pesticide-test', this)">
                                <i class="fas fa-seedling mr-3"></i>果蔬农残检测
                            </button>
                        </li>
                        <li class="mb-1">
                            <button class="nav-btn w-full text-left px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" onclick="showSection('oil-test', this)">
                                <i class="fas fa-oil-can mr-3"></i>食用油品质检测
                            </button>
                        </li>
                        <li class="mb-1">
                            <button class="nav-btn w-full text-left px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" onclick="showSection('lean-meat-test', this)">
                                <i class="fas fa-drumstick-bite mr-3"></i>瘦肉精检测
                            </button>
                        </li>
                        <li class="mb-1">
                            <button class="nav-btn w-full text-left px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center" onclick="showSection('pathogen-test', this)">
                                <i class="fas fa-virus mr-3"></i>病原体检测
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>

            <!-- 主内容区 -->
            <div class="flex-1">
                <!-- 数据看板 -->
                <div id="dashboard" class="content-section">
                    <!-- 添加 id="dashboard-capture-area" 用于截图生成PDF -->
                    <div id="dashboard-capture-area" class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-chart-line text-blue-600 mr-2"></i>数据看板（分类）
                            </h2>
                            <!-- data-html2canvas-ignore="true" 属性让这个区域在生成PDF时不显示 -->
                            <div class="flex flex-wrap items-center gap-2" data-html2canvas-ignore="true">
                                <!-- 日期筛选区域 -->
                                <select id="dateFilterType" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="updateDateFilterOptions()">
                                    <option value="all">全部数据</option>
                                    <option value="day">按日</option>
                                    <option value="month">按月</option>
                                    <option value="range">时间段</option>
                                </select>
                                
                                <div id="dayFilterContainer" class="hidden filter-option">
                                    <input type="date" id="dayFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div id="monthFilterContainer" class="hidden filter-option">
                                    <input type="month" id="monthFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div id="rangeFilterContainer" class="hidden filter-option flex items-center">
                                    <input type="date" id="startDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="开始">
                                    <span class="mx-1">-</span>
                                    <input type="date" id="endDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="结束">
                                </div>
                                
                                <button class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm" onclick="loadDashboardData()">
                                    <i class="fas fa-filter mr-1"></i>筛选
                                </button>

                                <div class="h-6 w-px bg-gray-300 mx-1"></div>

                                <input type="date" id="reportDate" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm" onclick="generatePDF()">
                                    <i class="fas fa-file-pdf mr-2"></i>生成日报
                                </button>
                            </div>
                        </div>

                        <!-- 分类卡片 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6 mb-6">
                            <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg p-4 text-white shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">餐具洁净度检测</p>
                                        <p class="text-3xl font-bold" id="card_tableware_count">0</p>
                                        <p class="text-xs mt-1">合格率: <span id="card_tableware_pass">100%</span></p>
                                    </div>
                                    <i class="fas fa-utensils text-4xl opacity-50"></i>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-green-400 to-green-600 rounded-lg p-4 text-white shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">果蔬农残检测</p>
                                        <p class="text-3xl font-bold" id="card_pesticide_count">0</p>
                                        <p class="text-xs mt-1">合格率: <span id="card_pesticide_pass">100%</span></p>
                                    </div>
                                    <i class="fas fa-leaf text-4xl opacity-50"></i>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-lg p-4 text-white shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">食用油品质快检</p>
                                        <p class="text-3xl font-bold" id="card_oil_count">0</p>
                                        <p class="text-xs mt-1">合格率: <span id="card_oil_pass">100%</span></p>
                                    </div>
                                    <i class="fas fa-oil-can text-4xl opacity-50"></i>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-red-400 to-red-600 rounded-lg p-4 text-white shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">瘦肉精快检</p>
                                        <p class="text-3xl font-bold" id="card_lean_count">0</p>
                                        <p class="text-xs mt-1">合格率: <span id="card_lean_pass">100%</span></p>
                                    </div>
                                    <i class="fas fa-drumstick-bite text-4xl opacity-50"></i>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-400 to-purple-600 rounded-lg p-4 text-white shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">食源性细菌/病毒检测</p>
                                        <p class="text-3xl font-bold" id="card_pathogen_count">0</p>
                                        <p class="text-xs mt-1">阳性数: <span id="card_pathogen_positive">0</span></p>
                                    </div>
                                    <i class="fas fa-virus text-4xl opacity-50"></i>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-orange-400 to-orange-600 rounded-lg p-4 text-white shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">总检测数</p>
                                        <p class="text-3xl font-bold" id="card_total_count">0</p>
                                        <p class="text-xs mt-1" id="date_range_text">全部数据</p>
                                    </div>
                                    <i class="fas fa-clipboard-list text-4xl opacity-50"></i>
                                </div>
                            </div>
                        </div>

                        <!-- 分类概览列表 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white border rounded-lg p-4">
                                <h3 class="font-semibold text-gray-800 mb-3">餐具洁净度概览</h3>
                                <ul id="list_tableware_overview" class="text-sm text-gray-700 space-y-2"><li>暂无数据</li></ul>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <h3 class="font-semibold text-gray-800 mb-3">果蔬农残概览</h3>
                                <ul id="list_pesticide_overview" class="text-sm text-gray-700 space-y-2"><li>暂无数据</li></ul>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <h3 class="font-semibold text-gray-800 mb-3">食用油品质概览</h3>
                                <ul id="list_oil_overview" class="text-sm text-gray-700 space-y-2"><li>暂无数据</li></ul>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <h3 class="font-semibold text-gray-800 mb-3">瘦肉精概览</h3>
                                <ul id="list_lean_overview" class="text-sm text-gray-700 space-y-2"><li>暂无数据</li></ul>
                            </div>
                            <div class="bg-white border rounded-lg p-4 md:col-span-2">
                                <h3 class="font-semibold text-gray-800 mb-3">食源性细菌/病毒概览</h3>
                                <ul id="list_pathogen_overview" class="text-sm text-gray-700 space-y-2"><li>暂无数据</li></ul>
                            </div>
                        </div>

                        <!-- 图表区域 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="font-semibold mb-3 text-gray-700">本月检测趋势</h3>
                                <canvas id="trendChart" height="200"></canvas>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="font-semibold mb-3 text-gray-700">各食堂合格率对比</h3>
                                <canvas id="canteenChart" height="200"></canvas>
                            </div>
                        </div>

                        <!-- 风险提示 -->
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-circle text-yellow-600 text-xl mr-3 mt-1"></i>
                                <div>
                                    <h3 class="font-bold text-yellow-800 mb-2">风险提示</h3>
                                    <ul class="text-sm text-yellow-700 space-y-1" id="riskAlerts">
                                        <li>• 暂无风险提示</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据导出模块 -->
                <div id="export-data" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-file-export text-blue-600 mr-2"></i>数据导出
                        </h2>
                        
                        <div class="bg-blue-50 border border-blue-200 text-blue-900 rounded-lg p-4 mb-4 text-sm">
                            说明：选择日期范围导出检测数据报告，可预览报告内容并下载PDF格式。
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">报告设置</h3>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">报告日期</label>
                                    <input type="date" id="exportReportDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">数据范围</label>
                                    <select id="exportDateRange" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="day">当日数据</option>
                                        <option value="week">本周数据</option>
                                        <option value="month">本月数据</option>
                                        <option value="custom">自定义范围</option>
                                    </select>
                                </div>
                                
                                <div id="exportCustomRange" class="mb-4 hidden">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">开始日期</label>
                                            <input type="date" id="exportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">结束日期</label>
                                            <input type="date" id="exportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">报告标题</label>
                                    <input type="text" id="exportTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="食品安全检测报告">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">报告备注</label>
                                    <textarea id="exportNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2" placeholder="可选：添加报告备注说明"></textarea>
                                </div>
                                
                                <div class="flex justify-between mt-6">
                                    <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" onclick="previewExportReport()">
                                        <i class="fas fa-eye mr-2"></i>预览报告
                                    </button>
                                    <button type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" onclick="generateExportPDF()">
                                        <i class="fas fa-file-pdf mr-2"></i>导出PDF
                                    </button>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">报告预览</h3>
                                
                                <div id="reportPreviewEmpty" class="text-center py-12 text-gray-500">
                                    <i class="fas fa-file-alt text-4xl mb-3"></i>
                                    <p>请选择日期并点击"预览报告"按钮查看报告内容</p>
                                </div>
                                
                                <!-- 增加背景色 padding，方便截图 -->
                                <div id="reportPreviewContent" class="hidden bg-white p-4">
                                    <div class="text-center mb-4 border-b pb-4">
                                        <h4 class="text-xl font-bold" id="previewTitle">食品安全检测报告</h4>
                                        <p class="text-sm text-gray-600" id="previewDateRange">2025年11月29日</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h5 class="font-semibold border-b pb-1 mb-2">检测统计数据</h5>
                                        <ul class="text-sm space-y-2" id="previewStats">
                                            <!-- 统计数据将通过JS填充 -->
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h5 class="font-semibold border-b pb-1 mb-2">风险提示</h5>
                                        <ul class="text-sm space-y-1" id="previewRisks">
                                            <!-- 风险提示将通过JS填充 -->
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-4" id="previewNotesContainer">
                                        <h5 class="font-semibold border-b pb-1 mb-2">备注</h5>
                                        <p class="text-sm text-gray-700 bg-gray-50 p-2 rounded" id="previewNotesText"></p>
                                    </div>
                                    
                                    <div class="text-xs text-gray-500 mt-8 text-center">
                                        <p>本报告由食品安全检测系统自动生成</p>
                                        <p id="previewGenTime"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 餐具洁净度检测管理 (ATP) -->
                <div id="tableware-test" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-utensils text-blue-600 mr-2"></i>餐具洁净度检测管理 (ATP - SOP-04)
                        </h2>
                        
                        <form id="tablewareTestForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测日期 *</label>
                                    <input type="date" name="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">食堂编号 *</label>
                                    <select name="canteen" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">请选择</option>
                                        <option value="一食堂">一食堂</option>
                                        <option value="二食堂">二食堂</option>
                                        <option value="三食堂">三食堂</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测时间 *</label>
                                    <input type="time" name="testTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="13:00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测员 *</label>
                                    <input type="text" name="inspector" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="输入姓名">
                                </div>
                            </div>

                            <!-- ATP 点位 -->
                            <div id="atpPointsContainer" class="space-y-4">
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 atp-point">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">检测点位 *</label>
                                            <select name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                                <option value="">请选择</option>
                                                <option value="餐具表面">餐具表面</option>
                                                <option value="砧板表面">砧板表面</option>
                                                <option value="操作台面">操作台面</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">RLU读数 *</label>
                                            <input type="number" name="rluValue" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="输入数值">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">判定结果 *</label>
                                            <select name="result" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                                <option value="">请选择</option>
                                                <option value="合格">合格 (&lt;200)</option>
                                                <option value="警戒">警戒 (200-500)</option>
                                                <option value="不合格">不合格 (&gt;500)</option>
                                            </select>
                                        </div>
                                        <div class="flex items-end">
                                            <button type="button" onclick="removeAtpPoint(this)" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                                <i class="fas fa-trash mr-1"></i>删除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" onclick="addAtpPoint()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                                <i class="fas fa-plus mr-2"></i>添加检测点位
                            </button>

                            <!-- 整改记录 -->
                            <div class="border border-yellow-200 rounded-lg p-4 bg-yellow-50">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">
                                    <i class="fas fa-wrench text-yellow-600 mr-2"></i>整改记录(如需要)
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">整改措施</label>
                                        <textarea name="correctiveAction" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="描述清洗方式、消毒液浓度等"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">复检结果</label>
                                        <textarea name="recheckResult" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="复检RLU值及达标情况"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-save mr-2"></i>保存记录
                                </button>
                                <button type="reset" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-redo mr-2"></i>重置
                                </button>
                            </div>
                        </form>

                        <!-- 历史记录 -->
                        <div class="mt-8 border-t pt-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">
                                <i class="fas fa-history mr-2"></i>历史记录
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">日期</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">食堂</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">检测点位</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">RLU值</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">结果</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">检测员</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablewareRecords">
                                        <tr>
                                            <td colspan="7" class="border border-gray-300 px-4 py-8 text-center text-gray-500">暂无记录数据</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 果蔬农残检测管理 -->
                <div id="pesticide-test" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-leaf text-blue-600 mr-2"></i>果蔬农残检测管理 (SOP-01)
                        </h2>
                        
                        <form id="pesticideTestForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测日期 *</label>
                                    <input type="date" name="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">食堂编号 *</label>
                                    <select name="canteen" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">请选择</option>
                                        <option value="一食堂">一食堂</option>
                                        <option value="二食堂">二食堂</option>
                                        <option value="三食堂">三食堂</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测员 *</label>
                                    <input type="text" name="inspector" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="输入姓名">
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">样本信息</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">蔬菜/水果品种 *</label>
                                        <input type="text" name="vegetableType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="如:小白菜/苹果">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">供应商 *</label>
                                        <input type="text" name="supplier" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="供应商名称">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">批次号 *</label>
                                        <input type="text" name="batchNo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="批次编号">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">采样量(g) *</label>
                                        <input type="number" name="sampleWeight" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="≥500g">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">检测结果 *</label>
                                        <select name="result" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">请选择</option>
                                            <option value="合格">阴性-合格</option>
                                            <option value="不合格">显色超标-不合格</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                                        <input type="text" name="note" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="可选">
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-save mr-2"></i>保存记录
                                </button>
                                <button type="reset" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-redo mr-2"></i>重置
                                </button>
                            </div>
                        </form>

                        <!-- 历史记录 -->
                        <div class="mt-8 border-t pt-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">
                                <i class="fas fa-history mr-2"></i>历史记录
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">日期</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">食堂</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">品种</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">供应商</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">批次号</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">结果</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">检测员</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pesticideRecords">
                                        <tr><td colspan="9" class="border border-gray-300 px-4 py-8 text-center text-gray-500">暂无记录数据</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 食用油品质快检管理 -->
                <div id="oil-test" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-oil-can text-blue-600 mr-2"></i>食用油品质快检管理 (SOP-03)
                        </h2>
                        
                        <form id="oilTestForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测日期 *</label>
                                    <input type="date" name="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">食堂编号 *</label>
                                    <select name="canteen" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">请选择</option>
                                        <option value="一食堂">一食堂</option>
                                        <option value="二食堂">二食堂</option>
                                        <option value="三食堂">三食堂</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测员 *</label>
                                    <input type="text" name="inspector" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="输入姓名">
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">检测信息</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">油龄(天) *</label>
                                        <input type="number" step="0.1" name="oilAge" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="累计使用天数">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">油温(℃) *</label>
                                        <input type="number" name="oilTemp" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="80-100℃">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">颜色等级 *</label>
                                        <select name="colorLevel" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">请选择</option>
                                            <option value="合格">绿色-合格</option>
                                            <option value="警戒">黄色-警戒</option>
                                            <option value="不合格">红色-不合格</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">TPM估值(%) *</label>
                                        <input type="number" name="tpmValue" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="<25%">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                                        <input type="text" name="note" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="可选">
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-save mr-2"></i>保存记录
                                </button>
                                <button type="reset" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-redo mr-2"></i>重置
                                </button>
                            </div>
                        </form>

                        <!-- 历史记录 -->
                        <div class="mt-8 border-t pt-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">
                                <i class="fas fa-history mr-2"></i>历史记录
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">日期</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">食堂</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">油龄(天)</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">油温(℃)</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">TPM(%)</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">结果</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">检测员</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="oilRecords">
                                        <tr><td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">暂无记录数据</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 瘦肉精快检管理 -->
                <div id="lean-meat-test" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-drumstick-bite text-blue-600 mr-2"></i>瘦肉精快检管理 (SOP-02)
                        </h2>
                        
                        <form id="leanMeatTestForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测日期 *</label>
                                    <input type="date" name="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">食堂编号 *</label>
                                    <select name="canteen" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">请选择</option>
                                        <option value="一食堂">一食堂</option>
                                        <option value="二食堂">二食堂</option>
                                        <option value="三食堂">三食堂</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">检测员 *</label>
                                    <input type="text" name="inspector" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="输入姓名">
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">样本信息</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">肉类品种 *</label>
                                        <select name="meatType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">请选择</option>
                                            <option value="猪肉">猪肉</option>
                                            <option value="牛肉">牛肉</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">供应商 *</label>
                                        <input type="text" name="supplier" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="供应商名称">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">批次号 *</label>
                                        <input type="text" name="batchNo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">采样量(g) *</label>
                                        <input type="number" name="sampleWeight" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="≥100g">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">检测结果 *</label>
                                        <select name="result" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">请选择</option>
                                            <option value="合格">三项阴性-合格</option>
                                            <option value="不合格-克伦特罗">克伦特罗阳性</option>
                                            <option value="不合格-莱克多巴胺">莱克多巴胺阳性</option>
                                            <option value="不合格-沙丁胺醇">沙丁胺醇阳性</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                                        <input type="text" name="note" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="可选">
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-save mr-2"></i>保存记录
                                </button>
                                <button type="reset" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-redo mr-2"></i>重置
                                </button>
                            </div>
                        </form>

                        <!-- 历史记录 -->
                        <div class="mt-8 border-t pt-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">
                                <i class="fas fa-history mr-2"></i>历史记录
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">日期</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">食堂</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">肉类品种</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">供应商</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">批次号</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">结果</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">检测员</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leanMeatRecords">
                                        <tr><td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">暂无记录数据</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 食源性细菌/病毒检测管理（导入） -->
                <div id="pathogen-test" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-virus text-blue-600 mr-2"></i>食源性细菌/病毒检测管理（导入模式）(PCR - SOP-05)
                        </h2>

                        <div class="bg-blue-50 border border-blue-200 text-blue-900 rounded-lg p-4 mb-4 text-sm">
                            说明：此模块通过导入芯片检测结果报告文件，统一采集信息并上传到系统。支持CSV/JSON两种格式。
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 mb-6">
                            <h3 class="font-semibold text-lg mb-3 text-gray-800">导入芯片检测报告</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">选择文件（Word/CSV/JSON）</label>
                                    <input type="file" id="pathogenFileInput" accept=".docx,.csv,.json" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div class="flex gap-2">
                                    <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" onclick="importPathogenReport()">
                                        <i class="fas fa-upload mr-2"></i>导入
                                    </button>
                                    <button type="button" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition" onclick="downloadPathogenTemplate()">
                                        <i class="fas fa-download mr-2"></i>下载模板
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mt-2">支持 Word (.docx)、CSV、JSON 格式。导入成功后自动汇总生成记录。</p>
                        </div>

                        <!-- 历史记录（导入结果） -->
                        <div class="border-t pt-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">
                                <i class="fas fa-history mr-2"></i>历史记录（导入）
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">日期</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">样本编号</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">食堂</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">样本类型</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">阳性项</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">风险等级</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">采样人</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pathogenRecords">
                                        <tr><td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">暂无记录数据</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 阳性结果详情模态框 -->
    <div id="positiveDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="sticky top-0 bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-bold">阳性检测结果详情</h3>
                <button onclick="closePositiveDetails()" class="text-white hover:bg-blue-700 px-3 py-1 rounded">✕</button>
            </div>
            
            <div class="p-6">
                <!-- 样本信息 -->
                <div class="mb-6 pb-4 border-b">
                    <h4 class="font-bold text-gray-800 mb-3">
                        <i class="fas fa-vial text-blue-600 mr-2"></i>样本信息
                    </h4>
                    <div id="sampleInfoContent" class="text-sm text-gray-700 grid grid-cols-2 gap-2">
                    </div>
                </div>
                
                <!-- 阳性项目列表 -->
                <div class="mb-4">
                    <h4 class="font-bold text-gray-800 mb-3">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>检测到阳性项目
                    </h4>
                    <div id="positiveItemsContent" class="space-y-3">
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-100 px-6 py-3 text-right border-t">
                <button onclick="closePositiveDetails()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">关闭</button>
            </div>
        </div>
    </div>

    <!-- 页面底部 -->
    <footer class="bg-gray-800 text-white p-4 mt-8">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm">&copy; 2025 食品安全检测管理系统 | 版本 1.0.0</p>
                </div>
                <div class="text-sm">
                    <a href="#" class="text-gray-300 hover:text-white mr-4">使用帮助</a>
                    <a href="#" class="text-gray-300 hover:text-white mr-4">隐私政策</a>
                    <a href="#" class="text-gray-300 hover:text-white">联系我们</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- 核心逻辑脚本 -->
    <script>
        // ================= 初始化逻辑 =================
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前日期
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('currentDate').textContent = dateStr;
            
            // 初始化日期输入框默认值
            const todayStr = today.toISOString().split('T')[0];
            const monthStr = todayStr.substring(0, 7);
            
            // 看板日期设置
            document.getElementById('reportDate').value = todayStr;
            document.getElementById('dayFilter').value = todayStr;
            document.getElementById('monthFilter').value = monthStr;
            document.getElementById('startDateFilter').value = todayStr;
            document.getElementById('endDateFilter').value = todayStr;
            
            //             // 初始化图表和数据
            initCharts();
            loadAllRecords();
            loadDashboardData();
        });

        // ================= 导航栏逻辑 =================
        function showSection(sectionId, btn) {
            // 隐藏所有部分
            document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
            // 显示目标部分
            document.getElementById(sectionId).classList.remove('hidden');
            
            // 更新按钮状态
            if (btn) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        }

        // ================= 看板筛选逻辑 =================
        function updateDateFilterOptions() {
            const type = document.getElementById('dateFilterType').value;
            // 隐藏所有筛选选项
            document.querySelectorAll('.filter-option').forEach(el => el.classList.add('hidden'));
            
            // 根据选择显示对应的输入框
            if (type === 'day') {
                document.getElementById('dayFilterContainer').classList.remove('hidden');
            } else if (type === 'month') {
                document.getElementById('monthFilterContainer').classList.remove('hidden');
            } else if (type === 'range') {
                document.getElementById('rangeFilterContainer').classList.remove('hidden');
            }
        }

        // ================= 数据管理 (CRUD) =================
        
        // 保存记录通用函数
        function saveRecord(type, formData) {
            let records = JSON.parse(localStorage.getItem(`${type}Records`) || '[]');
            const record = { id: Date.now(), timestamp: new Date().toISOString() };
            
            for (let [key, value] of formData.entries()) {
                record[key] = value;
            }

            // 特殊处理 ATP 点位
            if (type === 'tableware') {
                const points = [];
                document.querySelectorAll('#atpPointsContainer .atp-point').forEach(point => {
                    const loc = point.querySelector('[name="location"]').value;
                    const rlu = point.querySelector('[name="rluValue"]').value;
                    const res = point.querySelector('[name="result"]').value;
                    if (loc && rlu && res) points.push({ loc, rlu, res });
                });
                record.atpPoints = points;
            }

            records.unshift(record); // 添加到开头
            localStorage.setItem(`${type}Records`, JSON.stringify(records));

            alert('记录保存成功！');
            loadRecords(type);
            loadDashboardData(); // 刷新看板
            
            // 重置表单
            if(type === 'tableware') {
                document.getElementById('tablewareTestForm').reset();
            } else {
                document.getElementById(`${type}TestForm`).reset();
            }
        }

        // 绑定表单提交事件
        document.getElementById('tablewareTestForm')?.addEventListener('submit', function(e) { e.preventDefault(); saveRecord('tableware', new FormData(this)); });
        document.getElementById('pesticideTestForm')?.addEventListener('submit', function(e) { e.preventDefault(); saveRecord('pesticide', new FormData(this)); });
        document.getElementById('oilTestForm')?.addEventListener('submit', function(e) { e.preventDefault(); saveRecord('oil', new FormData(this)); });
        document.getElementById('leanMeatTestForm')?.addEventListener('submit', function(e) { e.preventDefault(); saveRecord('leanMeat', new FormData(this)); });

        // 加载所有记录
        function loadAllRecords() {
            loadRecords('tableware');
            loadRecords('pesticide');
            loadRecords('oil');
            loadRecords('leanMeat');
            loadRecords('pathogen');
        }

        // 加载单个类型的记录到表格
        function loadRecords(type) {
            const records = JSON.parse(localStorage.getItem(`${type}Records`) || '[]');
            const tbody = document.getElementById(`${type}Records`);
            
            if (!records.length) {
                tbody.innerHTML = `<tr><td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">暂无记录数据</td></tr>`;
                return;
            }
            
            tbody.innerHTML = '';
            
            // 根据不同类型渲染表格行
            if (type === 'tableware') {
                records.forEach(record => {
                    if (!record.atpPoints || !record.atpPoints.length) return;
                    record.atpPoints.forEach((point, idx) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="border border-gray-300 px-4 py-2">${idx === 0 ? record.testDate : ''}</td>
                            <td class="border border-gray-300 px-4 py-2">${idx === 0 ? record.canteen : ''}</td>
                            <td class="border border-gray-300 px-4 py-2">${point.loc}</td>
                            <td class="border border-gray-300 px-4 py-2">${point.rlu}</td>
                            <td class="border border-gray-300 px-4 py-2">
                                <span class="px-2 py-1 rounded-full text-xs ${point.res === '合格' ? 'bg-green-100 text-green-800' : point.res === '警戒' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${point.res}</span>
                            </td>
                            <td class="border border-gray-300 px-4 py-2">${idx === 0 ? record.inspector : ''}</td>
                            <td class="border border-gray-300 px-4 py-2">
                                ${idx === 0 ? `<button onclick="deleteRecord('tableware', ${record.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            } else if (type === 'pesticide') {
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="border border-gray-300 px-4 py-2">${record.testDate}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.canteen}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.vegetableType}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.supplier}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.batchNo}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${record.result === '合格' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${record.result}</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2">${record.inspector}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <button onclick="deleteRecord('pesticide', ${record.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else if (type === 'oil') {
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="border border-gray-300 px-4 py-2">${record.testDate}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.canteen}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.oilAge}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.oilTemp}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.tpmValue}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${record.colorLevel === '合格' ? 'bg-green-100 text-green-800' : record.colorLevel === '警戒' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${record.colorLevel}</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2">${record.inspector}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <button onclick="deleteRecord('oil', ${record.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else if (type === 'leanMeat') {
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="border border-gray-300 px-4 py-2">${record.testDate}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.canteen}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.meatType}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.supplier}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.batchNo}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${record.result.includes('合格') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${record.result}</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2">${record.inspector}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <button onclick="deleteRecord('leanMeat', ${record.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else if (type === 'pathogen') {
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    
                    // 如果有阳性项，显示为可点击的链接
                    let positiveItemsHtml = record.positiveItems;
                    if (record.positiveItems !== '无' && record.positiveDetails && record.positiveDetails.length > 0) {
                        positiveItemsHtml = `<a href="javascript:void(0)" class="text-blue-600 hover:text-blue-800 underline" onclick="showPositiveDetails(${record.id})">${record.positiveItems}</a>`;
                    }
                    
                    tr.innerHTML = `
                        <td class="border border-gray-300 px-4 py-2">${record.testDate}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.sampleId}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.canteen}</td>
                        <td class="border border-gray-300 px-4 py-2">${record.sampleType}</td>
                        <td class="border border-gray-300 px-4 py-2">${positiveItemsHtml}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${record.riskLevel === '低' ? 'bg-green-100 text-green-800' : record.riskLevel === '中' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${record.riskLevel}</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2">${record.inspector}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <button onclick="deleteRecord('pathogen', ${record.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    
                    // 存储详细信息，用于点击时显示
                    tr.dataset.recordId = record.id;
                    tr.dataset.positiveDetails = JSON.stringify(record.positiveDetails || []);
                    tr.dataset.sampleInfo = record.sampleInfo || '未知';
                });
            }
        }

        function deleteRecord(type, id) {
            if (!confirm('确定要删除此记录吗？')) return;
            let records = JSON.parse(localStorage.getItem(`${type}Records`) || '[]');
            records = records.filter(r => r.id !== id);
            localStorage.setItem(`${type}Records`, JSON.stringify(records));
            loadRecords(type);
            loadDashboardData();
        }

        // ATP 动态加减点位
        function addAtpPoint() {
            const container = document.getElementById('atpPointsContainer');
            const newPoint = container.firstElementChild.cloneNode(true);
            newPoint.querySelectorAll('input, select').forEach(input => { if (input.type !== 'button') input.value = ''; });
            container.appendChild(newPoint);
        }
        function removeAtpPoint(btn) {
            const container = document.getElementById('atpPointsContainer');
            if (container.children.length > 1) btn.closest('.atp-point').remove();
            else alert('至少需要保留一个检测点位');
        }

        // ================= 看板数据统计与图表 =================
        
        function loadDashboardData() {
            // 获取筛选日期范围
            const filterType = document.getElementById('dateFilterType').value;
            let startDate, endDate;
            
            const now = new Date();
            
            switch (filterType) {
                case 'day':
                    const day = document.getElementById('dayFilter').value || now.toISOString().split('T')[0];
                    startDate = new Date(day);
                    endDate = new Date(day);
                    endDate.setHours(23, 59, 59, 999);
                    document.getElementById('date_range_text').textContent = `${day} 当日`;
                    break;
                case 'month':
                    const month = document.getElementById('monthFilter').value || now.toISOString().substring(0, 7);
                    startDate = new Date(month + '-01');
                    endDate = new Date(startDate);
                    endDate.setMonth(endDate.getMonth() + 1);
                    endDate.setDate(0);
                    endDate.setHours(23, 59, 59, 999);
                    document.getElementById('date_range_text').textContent = `${month} 月`;
                    break;
                case 'range':
                    const start = document.getElementById('startDateFilter').value;
                    const end = document.getElementById('endDateFilter').value;
                    if(start && end) {
                        startDate = new Date(start);
                        endDate = new Date(end);
                        endDate.setHours(23, 59, 59, 999);
                        document.getElementById('date_range_text').textContent = `${start} 至 ${end}`;
                    } else {
                        // 默认全部
                        startDate = new Date(0);
                        endDate = new Date(2099, 11, 31);
                    }
                    break;
                default: // all
                    startDate = new Date(0);
                    endDate = new Date(2099, 11, 31);
                    document.getElementById('date_range_text').textContent = `全部数据`;
            }

            // 统计各模块数据
            const stats = {
                tableware: getStats('tableware', startDate, endDate),
                pesticide: getStats('pesticide', startDate, endDate),
                oil: getStats('oil', startDate, endDate),
                leanMeat: getStats('leanMeat', startDate, endDate),
                pathogen: getStats('pathogen', startDate, endDate)
            };

            // 更新卡片显示
            updateCard('tableware', stats.tableware);
            updateCard('pesticide', stats.pesticide);
            updateCard('oil', stats.oil);
            updateCard('lean', stats.leanMeat); 
            
            // 病原体特殊处理
            document.getElementById('card_pathogen_count').textContent = stats.pathogen.count;
            document.getElementById('card_pathogen_positive').textContent = stats.pathogen.positiveCount;

            // 更新总数
            const total = stats.tableware.count + stats.pesticide.count + stats.oil.count + stats.leanMeat.count + stats.pathogen.count;
            document.getElementById('card_total_count').textContent = total;

            // 更新概览列表
            updateOverviewList('tableware', stats.tableware.records);
            updateOverviewList('pesticide', stats.pesticide.records);
            updateOverviewList('oil', stats.oil.records);
            updateOverviewList('lean', stats.leanMeat.records);
            updateOverviewList('pathogen', stats.pathogen.records);

            // 更新风险提示
            updateRiskAlerts(stats);

            // 更新图表
            updateCharts(startDate, endDate);
        }

        // 通用统计函数
        function getStats(type, startDate, endDate) {
            const records = JSON.parse(localStorage.getItem(`${type}Records`) || '[]');
            const filtered = records.filter(r => {
                const d = new Date(r.testDate || r.timestamp);
                return d >= startDate && d <= endDate;
            });

            let count = 0;
            let passCount = 0;
            let positiveCount = 0;

            if (type === 'tableware') {
                filtered.forEach(r => {
                    if (r.atpPoints) {
                        count += r.atpPoints.length;
                        passCount += r.atpPoints.filter(p => p.res === '合格').length;
                    }
                });
            } else if (type === 'pathogen') {
                count = filtered.length;
                positiveCount = filtered.filter(r => r.positiveItems && r.positiveItems !== '无').length;
            } else {
                count = filtered.length;
                passCount = filtered.filter(r => r.result && r.result.includes('合格') || r.colorLevel === '合格').length;
            }

            const passRate = count > 0 ? Math.round((passCount / count) * 100) : 100;

            return { count, passCount, positiveCount, passRate, records: filtered };
        }

        function updateCard(type, stats) {
            const countEl = document.getElementById(`card_${type}_count`);
            const passEl = document.getElementById(`card_${type}_pass`);
            if(countEl) countEl.textContent = stats.count;
            if(passEl) passEl.textContent = `${stats.passRate}%`;
        }

        function updateOverviewList(type, records) {
            const listEl = document.getElementById(`list_${type}_overview`);
            if(!listEl) return;

            if (!records.length) {
                listEl.innerHTML = '<li>暂无数据</li>';
                return;
            }

            listEl.innerHTML = '';
            const recent = records.slice(0, 3);
            recent.forEach(r => {
                const li = document.createElement('li');
                let text = '';
                if(type === 'tableware') text = `${r.testDate} ${r.canteen} 检测${r.atpPoints?.length || 0}点位`;
                else if(type === 'pesticide') text = `${r.testDate} ${r.vegetableType} ${r.result}`;
                else if(type === 'oil') text = `${r.testDate} ${r.canteen} TPM:${r.tpmValue}%`;
                else if(type === 'lean' || type === 'leanMeat') text = `${r.testDate} ${r.meatType} ${r.result}`;
                else if(type === 'pathogen') text = `${r.testDate} ${r.sampleId} ${r.positiveItems}`;
                
                li.textContent = text;
                listEl.appendChild(li);
            });
        }

        function updateRiskAlerts(stats) {
            const alerts = [];
            if (stats.tableware.passRate < 90 && stats.tableware.count > 0) alerts.push(`餐具洁净度合格率偏低(${stats.tableware.passRate}%)`);
            if (stats.pesticide.passRate < 100 && stats.pesticide.count > 0) alerts.push(`存在农药残留超标蔬果`);
            if (stats.oil.passRate < 95 && stats.oil.count > 0) alerts.push(`食用油品质不合格率较高`);
            if (stats.leanMeat.passRate < 100 && stats.leanMeat.count > 0) alerts.push(`警告：检出瘦肉精阳性样本`);
            if (stats.pathogen.positiveCount > 0) alerts.push(`警告：检出食源性病原体`);

            const el = document.getElementById('riskAlerts');
            if (alerts.length) {
                el.innerHTML = alerts.map(a => `<li class="text-red-700 font-bold">• ${a}</li>`).join('');
            } else {
                el.innerHTML = '<li>• 暂无风险提示</li>';
            }
        }

        // ================= 图表逻辑 =================
        let trendChart, canteenChart;
        function initCharts() {
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: '合格率趋势', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4, fill: true }
                    ]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });

            const canteenCtx = document.getElementById('canteenChart').getContext('2d');
            canteenChart = new Chart(canteenCtx, {
                type: 'bar',
                data: {
                    labels: ['一食堂', '二食堂', '三食堂'],
                    datasets: [{ label: '合格率%', data: [0, 0, 0], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'] }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function updateCharts(startDate, endDate) {
            // 本月检测趋势：始终显示当前月份（1号到月末）的数据
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const monthStart = new Date(currentYear, currentMonth, 1);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);

            const trendData = calculateDailyTrend(monthStart, monthEnd);
            if(trendChart) {
                trendChart.data.labels = trendData.labels;
                trendChart.data.datasets[0].data = trendData.data;
                trendChart.update();
            }

            // 基于真实数据更新食堂合格率对比
            const canteenResult = calculateCanteenPassRate();
            if(canteenChart) {
                // 更新标签与数据
                canteenChart.data.labels = canteenResult.labels;
                canteenChart.data.datasets[0].data = canteenResult.data;
                canteenChart.update();
            }
        }

        // 计算日趋势数据（当月所有日期）
        function calculateDailyTrend(startDate, endDate) {
            const dailyStats = {};
            
            // 初始化当月所有日期
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                dailyStats[dateStr] = { passed: 0, total: 0 };
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // 统计所有检测类型
            const types = ['tableware', 'pesticide', 'oil', 'leanMeat', 'pathogen'];
            types.forEach(type => {
                const records = JSON.parse(localStorage.getItem(`${type}Records`) || '[]');
                records.forEach(record => {
                    const recordDate = record.testDate || record.timestamp?.split('T')[0];
                    if (!recordDate || !dailyStats[recordDate]) return;

                    if (type === 'tableware' && record.atpPoints) {
                        record.atpPoints.forEach(point => {
                            dailyStats[recordDate].total++;
                            if (point.res === '合格') dailyStats[recordDate].passed++;
                        });
                    } else if (type === 'pathogen') {
                        // 病原体检测计数
                        dailyStats[recordDate].total++;
                        if (record.positiveItems === '无' || !record.positiveItems) {
                            dailyStats[recordDate].passed++;
                        }
                    } else {
                        // 其他类型 (pesticide, oil, leanMeat)
                        dailyStats[recordDate].total++;
                        if (record.result?.includes('合格') || record.colorLevel === '合格') {
                            dailyStats[recordDate].passed++;
                        }
                    }
                });
            });

            // 构建图表数据 - 显示当月每一日的数据
            const labels = [];
            const data = [];
            let currentDate2 = new Date(startDate);
            while (currentDate2 <= endDate) {
                const dateStr = currentDate2.toISOString().split('T')[0];
                const day = currentDate2.getDate();
                const month = currentDate2.getMonth() + 1;
                labels.push(`${month}-${day}`); // 显示 MM-DD 格式
                
                const stat = dailyStats[dateStr];
                const passRate = stat.total > 0 ? Math.round((stat.passed / stat.total) * 100) : null;
                data.push(passRate);
                currentDate2.setDate(currentDate2.getDate() + 1);
            }

            return { labels, data };
        }

        // 计算食堂合格率
        function calculateCanteenPassRate() {
            // 综合统计所有检测类型（tableware 按点位计数，其他按记录计数，包括 pathogen）
            const types = ['tableware', 'pesticide', 'oil', 'leanMeat', 'pathogen'];

            // 收集所有出现过的食堂名称（从各类型记录中）
            const canteenSet = new Set();
            types.forEach(type => {
                const records = JSON.parse(localStorage.getItem(`${type}Records`) || '[]');
                records.forEach(r => {
                    if (r && r.canteen) canteenSet.add(r.canteen);
                });
            });

            // 如果没有任何记录中的 canteen，则使用默认三食堂
            const defaultCanteens = ['一食堂', '二食堂', '三食堂'];
            const canteens = canteenSet.size ? Array.from(canteenSet) : defaultCanteens;

            const labels = canteens;
            const data = [];

            canteens.forEach(canteen => {
                let totalCount = 0;
                let passCount = 0;

                types.forEach(type => {
                    const records = JSON.parse(localStorage.getItem(`${type}Records`) || '[]');
                    records.forEach(record => {
                        // 有些记录可能没有 canteen 字段; 忽略这些或尝试从 sampleInfo 中推断（parsePathogenReportText 已做推断）
                        if ((record.canteen || '') !== canteen) return;

                        if (type === 'tableware') {
                            if (record.atpPoints && record.atpPoints.length) {
                                record.atpPoints.forEach(point => {
                                    totalCount++;
                                    if (point.res === '合格') passCount++;
                                });
                            }
                        } else if (type === 'pathogen') {
                            // pathogen: 按样本计数，若 positiveItems === '无' 则视为合格
                            totalCount++;
                            if (!record.positiveItems || record.positiveItems === '无') passCount++;
                        } else {
                            // 其他类型按记录计数
                            totalCount++;
                            if ((record.result && record.result.includes('合格')) || record.colorLevel === '合格') {
                                passCount++;
                            }
                        }
                    });
                });

                const rate = totalCount > 0 ? Math.round((passCount / totalCount) * 100) : 0;
                data.push(rate);
            });

            return { labels, data };
        }

        // ================= 导出与 PDF (修复版：使用 html2canvas) =================
        
        // 1. 预览报告逻辑
        function previewExportReport() {
            document.getElementById('reportPreviewEmpty').classList.add('hidden');
            document.getElementById('reportPreviewContent').classList.remove('hidden');
            
            const title = document.getElementById('exportTitle').value;
            const date = document.getElementById('exportReportDate').value;
            const note = document.getElementById('exportNotes').value;
            const rangeType = document.getElementById('exportDateRange').value;
            const rangeText = document.getElementById('exportDateRange').options[document.getElementById('exportDateRange').selectedIndex].text;
            
            // 根据选定的日期范围计算 startDate 和 endDate
            let startDate, endDate;
            const reportDate = new Date(date);
            
            switch(rangeType) {
                case 'day':
                    startDate = new Date(reportDate);
                    endDate = new Date(reportDate);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    // 本周：周一至周日
                    const dayOfWeek = reportDate.getDay();
                    const diff = reportDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(reportDate.setDate(diff));
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    startDate = new Date(reportDate.getFullYear(), reportDate.getMonth(), 1);
                    endDate = new Date(reportDate.getFullYear(), reportDate.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'custom':
                    const customStart = document.getElementById('exportStartDate').value;
                    const customEnd = document.getElementById('exportEndDate').value;
                    if (!customStart || !customEnd) {
                        alert('请选择自定义日期范围');
                        return;
                    }
                    startDate = new Date(customStart);
                    endDate = new Date(customEnd);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                default:
                    startDate = new Date(reportDate);
                    endDate = new Date(reportDate);
                    endDate.setHours(23, 59, 59, 999);
            }
            
            // 根据日期范围统计数据
            const stats = {
                tableware: getStats('tableware', startDate, endDate),
                pesticide: getStats('pesticide', startDate, endDate),
                oil: getStats('oil', startDate, endDate),
                leanMeat: getStats('leanMeat', startDate, endDate),
                pathogen: getStats('pathogen', startDate, endDate)
            };
            
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewDateRange').textContent = `报告日期: ${date} | 范围: ${rangeText}`;
            document.getElementById('previewNotesText').textContent = note || "无";
            document.getElementById('previewGenTime').textContent = new Date().toLocaleString();

            // 填充统计数据 (根据选定日期范围计算)
            const tCount = stats.tableware.count;
            const tPass = stats.tableware.passRate;
            const pCount = stats.pesticide.count;
            const pPass = stats.pesticide.passRate;
            const oCount = stats.oil.count;
            const oPass = stats.oil.passRate;
            const lCount = stats.leanMeat.count;
            const lPass = stats.leanMeat.passRate;
            const pathCount = stats.pathogen.count;
            const pathPositive = stats.pathogen.positiveCount;
            
            const statsHtml = `
                <li class="flex justify-between border-b border-gray-100 py-1"><span>餐具洁净度</span> <span class="font-bold">检测 ${tCount} 次，合格率 ${tPass}%</span></li>
                <li class="flex justify-between border-b border-gray-100 py-1"><span>果蔬农残</span> <span class="font-bold">检测 ${pCount} 次，合格率 ${pPass}%</span></li>
                <li class="flex justify-between border-b border-gray-100 py-1"><span>食用油品质</span> <span class="font-bold">检测 ${oCount} 次，合格率 ${oPass}%</span></li>
                <li class="flex justify-between border-b border-gray-100 py-1"><span>瘦肉精检测</span> <span class="font-bold">检测 ${lCount} 次，合格率 ${lPass}%</span></li>
                <li class="flex justify-between border-b border-gray-100 py-1"><span>病原体检测</span> <span class="font-bold">检测 ${pathCount} 次，阳性 ${pathPositive} 次</span></li>
            `;
            document.getElementById('previewStats').innerHTML = statsHtml;
            
            // 填充风险提示（根据导出日期范围的数据）
            const alerts = [];
            if (stats.tableware.passRate < 90 && stats.tableware.count > 0) alerts.push(`<li class="text-red-700 font-bold">• 餐具洁净度合格率偏低(${stats.tableware.passRate}%)</li>`);
            if (stats.pesticide.passRate < 100 && stats.pesticide.count > 0) alerts.push(`<li class="text-red-700 font-bold">• 存在农药残留超标蔬果</li>`);
            if (stats.oil.passRate < 95 && stats.oil.count > 0) alerts.push(`<li class="text-red-700 font-bold">• 食用油品质不合格率较高</li>`);
            if (stats.leanMeat.passRate < 100 && stats.leanMeat.count > 0) alerts.push(`<li class="text-red-700 font-bold">• 警告：检出瘦肉精阳性样本</li>`);
            if (stats.pathogen.positiveCount > 0) alerts.push(`<li class="text-red-700 font-bold">• 警告：检出食源性病原体</li>`);
            
            if (alerts.length > 0) {
                document.getElementById('previewRisks').innerHTML = alerts.join('');
            } else {
                document.getElementById('previewRisks').innerHTML = '<li>• 暂无风险提示</li>';
            }
        }
        
        // 监听导出日期范围选择变化
        document.getElementById('exportDateRange')?.addEventListener('change', function() {
            const customRangeDiv = document.getElementById('exportCustomRange');
            if (this.value === 'custom') {
                customRangeDiv.classList.remove('hidden');
            } else {
                customRangeDiv.classList.add('hidden');
            }
        });

        // 2. 生成看板 PDF (使用 html2canvas 截图)
        function generatePDF() {
            const element = document.getElementById('dashboard-capture-area');
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            btn.disabled = true;

            // 使用 html2canvas 截图
            html2canvas(element, {
                scale: 2, // 提高清晰度
                useCORS: true, // 允许跨域图片
                backgroundColor: '#ffffff' // 确保背景白底
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                // A4 纸张尺寸 (mm)
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                
                // 计算图片在 PDF 中的尺寸
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * (pdfWidth - 20)) / imgProps.width; // 左右留10mm边距
                
                // 添加图片到 PDF
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, imgHeight);
                
                const date = document.getElementById('reportDate').value;
                pdf.save(`Dashboard-Report-${date}.pdf`);
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('日报生成成功！');
            }).catch(err => {
                console.error(err);
                alert('生成失败，请重试');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // 3. 导出详细报告 PDF (使用 html2canvas 截图预览区域)
        function generateExportPDF() {
            // 确保先预览，保证内容已填充
            previewExportReport();
            
            const element = document.getElementById('reportPreviewContent');
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 导出中...';
            btn.disabled = true;

            html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                
                // 留出边距
                const margin = 15;
                const contentWidth = pdfWidth - (margin * 2);
                
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * contentWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', margin, margin, contentWidth, imgHeight);
                
                const title = document.getElementById('exportTitle').value;
                pdf.save(`${title}.pdf`);
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('报告导出成功！');
            }).catch(err => {
                console.error(err);
                alert('导出失败，请重试');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // ================= 导入逻辑 =================
        function importPathogenReport() {
            const input = document.getElementById('pathogenFileInput');
            if (!input.files || !input.files[0]) { 
                alert('请选择文件'); 
                return; 
            }
            
            const file = input.files[0];
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.docx')) {
                importFromDocx(file);
            } else if (fileName.endsWith('.csv')) {
                importFromCsv(file);
            } else if (fileName.endsWith('.json')) {
                importFromJson(file);
            } else {
                alert('不支持的文件格式，请选择 .docx、.csv 或 .json 文件');
            }
        }
        
        // 从 Word 文档导入
        function importFromDocx(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    JSZip.loadAsync(arrayBuffer).then(zip => {
                        // 读取document.xml
                        zip.file('word/document.xml').async('string').then(xmlText => {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                            
                            // 提取文本内容 - 按段落提取以保留换行结构
                            const ns = 'http://schemas.openxmlformats.org/wordprocessingml/2006/main';
                            const paragraphs = xmlDoc.getElementsByTagNameNS(ns, 'p');
                            let fullText = '';
                            
                            for (let i = 0; i < paragraphs.length; i++) {
                                const para = paragraphs[i];
                                const textElements = para.getElementsByTagNameNS(ns, 't');
                                let paraText = '';
                                for (let j = 0; j < textElements.length; j++) {
                                    paraText += textElements[j].textContent;
                                }
                                if (paraText) {
                                    fullText += paraText + '\n';
                                }
                            }
                            
                            console.log('提取的文本内容:', fullText.substring(0, 500));
                            
                            // 解析文本内容
                            const record = parsePathogenReportText(fullText);
                            
                            if (record) {
                                // 保存到 localStorage
                                let records = JSON.parse(localStorage.getItem('pathogenRecords') || '[]');
                                record.id = Date.now();
                                record.timestamp = new Date().toISOString();
                                records.unshift(record);
                                localStorage.setItem('pathogenRecords', JSON.stringify(records));
                                
                                loadRecords('pathogen');
                                loadDashboardData();
                                
                                // 详细的成功提示
                                let alertMsg = `✓ 导入成功！\n\n`;
                                alertMsg += `样本编号: ${record.sampleId}\n`;
                                alertMsg += `检测日期: ${record.testDate}\n`;
                                alertMsg += `食堂信息: ${record.canteen}\n`;
                                alertMsg += `检测项目: ${record.sampleType}\n`;
                                alertMsg += `风险等级: ${record.riskLevel}\n\n`;
                                
                                if (record.positiveItems === '无') {
                                    alertMsg += `检测结果: ✓ 全部阴性`;
                                } else {
                                    alertMsg += `⚠ 检测到阳性:\n${record.positiveItems}`;
                                }
                                
                                alert(alertMsg);
                            } else {
                                alert('无法解析文档内容，请检查文档格式');
                            }
                        });
                    }).catch(err => {
                        console.error(err);
                        alert('Word文件读取失败，请重试');
                    });
                } catch (err) {
                    console.error(err);
                    alert('Word文件解析失败');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 解析检测报告文本
        function parsePathogenReportText(text) {
            try {
                // 基本字段匹配
                const sampleIdMatch = text.match(/样本编号[\s:：]*([A-Za-z0-9\-\_]+)/);
                const testDateMatch = text.match(/检测开始时间[：:\s]*?(\d{4}-\d{2}-\d{2})/);
                const inspectorMatch = text.match(/检测人员[：:\s]*([\u4e00-\u9fa5A-Za-z0-9\-\_]+)/) || text.match(/检验人员[：:\s]*([\u4e00-\u9fa5A-Za-z0-9\-\_]+)/);

                // 行数组（去除空白行，保留顺序）
                const rawLines = text.split(/[\n\r]+/);
                const lines = rawLines.map(l => l.trim()).filter(l => l.length > 0);

                // 尝试提取样本信息行（样本信息: ... 或 单独一行“样本信息”+下一行）
                let sampleInfo = '';
                for (let i = 0; i < lines.length; i++) {
                    const l = lines[i];
                    const m = l.match(/样本信息\s*[:：]?\s*(.+)/);
                    if (m && m[1]) { sampleInfo = m[1].trim(); break; }
                    if (l === '样本信息' && i + 1 < lines.length) { sampleInfo = lines[i + 1]; break; }
                }

                // 如果没有直接的样本信息，再尝试从包含“样本编号”附近的行获取更多信息
                if (!sampleInfo) {
                    for (let i = 0; i < lines.length; i++) {
                        if (/样本编号/.test(lines[i]) && i + 1 < lines.length) {
                            sampleInfo = lines[i + 1];
                            break;
                        }
                    }
                }

                // 规范化样本信息为单行字符串
                sampleInfo = sampleInfo || '';

                // 识别食堂（优先使用样本信息，其次全文搜索）
                const canteenCandidates = [
                    {keys: ['一食堂','食堂一','1食堂','1餐','第1食堂'], name: '一食堂'},
                    {keys: ['二食堂','食堂二','2食堂','2餐','第2食堂'], name: '二食堂'},
                    {keys: ['三食堂','食堂三','3食堂','3餐','第3食堂'], name: '三食堂'}
                ];

                let canteen = '未知';
                const searchArea = (sampleInfo + '\n' + text).replace(/\s+/g, ' ');
                for (const cand of canteenCandidates) {
                    for (const k of cand.keys) {
                        if (searchArea.indexOf(k) !== -1) { canteen = cand.name; break; }
                    }
                    if (canteen !== '未知') break;
                }

                // 如果仍未找到，但样本信息包含“餐盘”或“留样”等，尝试根据上下文推断
                if (canteen === '未知' && /餐盘|餐具|餐盒|留样/.test(sampleInfo)) {
                    // 尝试从样本信息中提取前缀数字或文字（例如“1号餐盘”）
                    const numMatch = sampleInfo.match(/([一二三]|[1-3])[号\s]?/);
                    if (numMatch) {
                        const m = numMatch[1];
                        if (/一|1/.test(m)) canteen = '一食堂';
                        if (/二|2/.test(m)) canteen = '二食堂';
                        if (/三|3/.test(m)) canteen = '三食堂';
                    }
                }

                // 提取阳性检测项及详细信息（保留之前的健壮查找策略）
                let positiveItems = [];
                let positiveDetails = [];

                for (let i = 0; i < lines.length; i++) {
                    if (lines[i] === '阳性' || /阳性/.test(lines[i])) {
                        // 优先按表格通常结构：序号 / 靶标 / 通道 / Ct / 结果（阳性）
                        let foundTarget = false;

                        // 向前查找靶标（尝试几个常见偏移）
                        const offsets = [3,4,5,2];
                        for (let off of offsets) {
                            if (i - off >= 0) {
                                const targetLine = lines[i - off].trim();
                                const channelLine = (i - off + 1 >= 0 && i - off + 1 < lines.length) ? lines[i - off + 1].trim() : '';
                                const ctCandidate = (i - 1 >= 0) ? lines[i - 1].trim() : '';

                                if (!targetLine) continue;
                                if (/^(序号|检测靶标|通道|Ct|结果)$/i.test(targetLine)) continue;
                                if (/^(FAM|HEX|ROX|CY5)[\-\d]*$/i.test(targetLine)) continue;

                                // 认为包含中文名称的才是候选靶标
                                if (/[\u4e00-\u9fa5]/.test(targetLine) && !positiveItems.includes(targetLine)) {
                                    positiveItems.push(targetLine);
                                    positiveDetails.push({
                                        name: targetLine,
                                        ctValue: ctCandidate || '',
                                        channel: channelLine || '',
                                        result: '阳性',
                                        lineIndex: i
                                    });
                                    console.log('找到阳性项目:', targetLine, 'Ct:', ctCandidate, 'channel:', channelLine);
                                    foundTarget = true;
                                    break;
                                }
                            }
                        }
                    }
                }

                console.log('最终提取到的阳性项目:', positiveItems, '数量:', positiveItems.length);

                // 风险等级判定
                let riskLevel = '低';
                if (positiveItems.length >= 2) riskLevel = '高';
                else if (positiveItems.length === 1) riskLevel = '中';

                // 最终构建记录
                const record = {
                    testDate: testDateMatch ? testDateMatch[1] : new Date().toISOString().split('T')[0],
                    sampleId: sampleIdMatch ? sampleIdMatch[1] : 'S-' + Date.now(),
                    canteen: canteen,
                    sampleType: '肠道25项芯片',
                    sampleInfo: sampleInfo || '未知',
                    positiveItems: positiveItems.length > 0 ? positiveItems.join(', ') : '无',
                    positiveDetails: positiveDetails,
                    riskLevel: riskLevel,
                    inspector: inspectorMatch ? inspectorMatch[1] : '系统导入',
                    source: 'docx'
                };

                console.log('最终解析结果:', record);
                return record;
            } catch (err) {
                console.error('文本解析错误:', err);
                return null;
            }
        }
        
        // 从 CSV 导入
        function importFromCsv(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    if (lines.length < 2) {
                        alert('CSV 文件格式不正确');
                        return;
                    }
                    
                    // 跳过表头行
                    let records = JSON.parse(localStorage.getItem('pathogenRecords') || '[]');
                    let count = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const fields = line.split(',');
                        if (fields.length < 4) continue;
                        
                        const record = {
                            id: Date.now() + i,
                            testDate: fields[0].trim(),
                            sampleId: fields[1].trim(),
                            canteen: fields[2].trim(),
                            sampleType: '芯片检测样本',
                            positiveItems: fields[3].trim() === '阳性' ? '检测阳性' : '无',
                            riskLevel: fields[3].trim() === '阳性' ? '高' : '低',
                            inspector: '系统导入',
                            timestamp: new Date().toISOString(),
                            source: 'csv'
                        };
                        records.unshift(record);
                        count++;
                    }
                    
                    localStorage.setItem('pathogenRecords', JSON.stringify(records));
                    loadRecords('pathogen');
                    loadDashboardData();
                    alert(`导入成功！共导入 ${count} 条记录`);
                } catch (err) {
                    console.error(err);
                    alert('CSV 文件读取失败');
                }
            };
            reader.readAsText(file, 'utf-8');
        }
        
        // 从 JSON 导入
        function importFromJson(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    const dataArray = Array.isArray(json) ? json : [json];
                    
                    let records = JSON.parse(localStorage.getItem('pathogenRecords') || '[]');
                    
                    dataArray.forEach((item, index) => {
                        const record = {
                            id: Date.now() + index,
                            testDate: item.testDate || new Date().toISOString().split('T')[0],
                            sampleId: item.sampleId || `S-${Date.now()}-${index}`,
                            canteen: item.canteen || '一食堂',
                            sampleType: item.sampleType || '芯片检测样本',
                            positiveItems: item.positiveItems || '无',
                            riskLevel: item.riskLevel || (item.positiveItems ? '高' : '低'),
                            inspector: item.inspector || '系统导入',
                            timestamp: new Date().toISOString(),
                            source: 'json'
                        };
                        records.unshift(record);
                    });
                    
                    localStorage.setItem('pathogenRecords', JSON.stringify(records));
                    loadRecords('pathogen');
                    loadDashboardData();
                    alert(`导入成功！共导入 ${dataArray.length} 条记录`);
                } catch (err) {
                    console.error(err);
                    alert('JSON 文件格式不正确或读取失败');
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        function downloadPathogenTemplate() {
            // 下载 CSV 模板
            const csvContent = `testDate,sampleId,canteen,result
2025-09-18,20250918-1,一食堂,阴性
2025-09-18,20250918-2,二食堂,阳性`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', '病原体检测导入模板.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ================= 阳性结果详情显示 =================
        function showPositiveDetails(recordId) {
            // 获取记录
            let records = JSON.parse(localStorage.getItem('pathogenRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('未找到该记录');
                return;
            }
            
            // 填充样本信息
            const sampleInfoContent = document.getElementById('sampleInfoContent');
            sampleInfoContent.innerHTML = `
                <div><strong>样本编号:</strong> ${record.sampleId}</div>
                <div><strong>检测日期:</strong> ${record.testDate}</div>
                <div><strong>食堂:</strong> ${record.canteen}</div>
                <div><strong>样本类型:</strong> ${record.sampleType}</div>
                <div><strong>样本信息:</strong> ${record.sampleInfo || '未知'}</div>
                <div><strong>采样人:</strong> ${record.inspector}</div>
            `;
            
            // 填充阳性项目详情
            const positiveItemsContent = document.getElementById('positiveItemsContent');
            if (record.positiveDetails && record.positiveDetails.length > 0) {
                let html = '';
                record.positiveDetails.forEach((detail, index) => {
                    html += `
                        <div class="bg-red-50 border border-red-200 rounded p-4">
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div><strong>项目名称:</strong> ${detail.name}</div>
                                <div><strong>Ct值:</strong> <span class="text-red-600 font-bold">${detail.ctValue}</span></div>
                                <div><strong>通道:</strong> ${detail.channel}</div>
                                <div><strong>结果:</strong> <span class="text-red-600 font-bold">${detail.result}</span></div>
                            </div>
                        </div>
                    `;
                });
                positiveItemsContent.innerHTML = html;
            } else {
                // 如果没有详细信息，显示简化版本
                positiveItemsContent.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded p-4">
                        <p class="text-sm">检测到阳性: <strong>${record.positiveItems}</strong></p>
                        <p class="text-sm text-gray-600 mt-2">详细的Ct值和项目信息已保存</p>
                    </div>
                `;
            }
            
            // 显示模态框
            document.getElementById('positiveDetailsModal').classList.remove('hidden');
        }
        
        function closePositiveDetails() {
            document.getElementById('positiveDetailsModal').classList.add('hidden');
        }
        
        // 点击模态框背景关闭
        document.getElementById('positiveDetailsModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closePositiveDetails();
            }
        });

    </script>
</body>
</html>

